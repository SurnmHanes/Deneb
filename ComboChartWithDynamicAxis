{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "A bar chart ",
  "data": {
    "name": "dataset"
  },
  "transform": [
    {
      "joinaggregate": [
        {"op": "max", "field": "KPI Actual Value (individual)", "as": "maxA"},
        {"op": "max", "field": "KPI Target Value (individual)", "as": "maxT"}
      ]
    },
    {"calculate": "datum.maxA > datum.maxT ? datum.maxA * 1.2: datum.maxT * 1.2", "as": "max"},
    {
      "calculate": " datum['Frequency'] == 'Month' ? timeFormat( datum.MonthCommencing, '%b %Y') : timeFormat( datum.WeekCommencing, '%d %b' )", "as": "SelectedDateFormatted"
    },
    {
      "calculate": "datum['Frequency'] == 'Month' ? datum.MonthCommencing : datum.WeekCommencing", "as": "SelectedDate"  
    },
    {
      "calculate": "datum['Frequency'] == 'Month' ? datum.SelectedDateFormatted : 'w/c ' + datum.SelectedDateFormatted", "as": "DynamicDateTitle"
    }


  ],
  "params": [
    {"name": "maxY", "expr": "data('data_0')[0]['max']"}
  ],
  "layer": [


  {"mark": 
    {"type": "bar"},
    "encoding": {
      "color": {
        "condition": {
          "test": "datum['KPI Actual Value (individual)'] < datum['KPI Target Value (individual)']",
          "value": "#981A1F"
      }, 
      "value": "#104B1C"
    },
    "tooltip":
      [
        {
          "field": "SelectedDateFormatted",
          "title": "Period" 
        },
        {
          "field": "KPI Actual Value (individual)",
          "title": "Actual"
        },
        {
          "field": "KPI Target Value (individual)",
          "title": "Target"
        },
        {
          "field": "KPI Actual vs Target % (individual)__formatted",
          "title": "Actual vs Target (%)"
        }
      ]
    }
  }, 

  {"mark": 
    { "type":"line", 
      "stroke": {"expr": "pbiColor(1)"},
      "strokeDash": [8,8],
      "point": true

    },
    "encoding": 
    {
      "y": {"field": "KPI Target Value (individual)"},
      "color":  {"value": "#fcb714" },
      "tooltip":
      [
        {
          "field": "DynamicDateTitle",
          "title": "Period" 
        },
        {
          "field": "KPI Target Value (individual)",
          "title": "Target"
        }
      ]
    }
  }
 ],
  "encoding": {
    "x": { 
      "field": "SelectedDateFormatted", 
      "type": "nominal", 
      "sort": { "field": "SelectedDate", "order": "ascending"},
      "axis": {
        "labelAngle": 0
      },
      "scale": {
        "paddingOuter": 0.25,
        "paddingInner": 0.2
      }
    },
    "y": 
    {
      "field": "KPI Actual Value (individual)", "type": "quantitative",
      "scale": 
      {
        "domain": {"expr": "[0,maxY]" },
        "nice": true 
      } 
    }

  }
}
